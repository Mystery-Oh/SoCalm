<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>보행자 안전도 평가 지도</title>
  <link rel="stylesheet" href="{{ url_for('static', filename = 'style.css') }}">
  <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey={{ tmap_app_key }}"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
  <header>
    <div class="header-container">
      <div id="socalm">
        <a href="/"><img src="{{ url_for('static', filename='SOCALM.png') }}" height="100px" width="100px"></a>
      </div>
      <div class="navigation">
        <ul>
          <div id="logout">
            <form method="post" action="/logout">
              <button type="submit" id="no-button">
                <i class="fas fa-sign-out-alt"></i>
              </button>
            </form>
          </div>

        </ul>
      </div>

    </div>
  </header>

  <main>
    <section id="point-a-map">
      <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div id="map" style="flex: 2;">
          <h2>지도 클릭 후 제보하기</h2>

          <button id="getLocationBtn" style="margin-bottom: 10px;"> 내 위치 보기</button>

          <div id="map-container" style="height: 700px;"></div>
        </div>

        <div id="report" style="flex: 1; display: none;">
          <div class="close-btn" id="close-report">✕</div>
          <h2>위험지역 제보</h2>
          <form id="report-form" action="/report" method="post">
            <label>위치명: <input type="text" name="location" required></label><br>
            <label>설명: <textarea name="description" required></textarea></label><br>
            <button type="submit">제보하기</button>
            <button type="button" id="cancel-report">취소하기</button>
          </form>
        </div>
      </div>
    </section>

    <div id="up-to">
      <a href="#"><img src="{{ url_for('static', filename='SOCALM.png') }}" height="70px" width="70px"></a>
    </div>
  </main>

  <footer>
    <h2>SoCalm</h2>
    <p>This project is an open source project. Our team is composed of members from the Department of Computer Engineering and the Department of Software.</p>
    <p style="font-size: 13px;">developers: (Oh-heeseung, Leejungjoo, Jang hyun gyu)<a href="https://github.com/Mystery-Oh/SoCalm"><img src="{{ url_for('static', filename='Github.png') }}" height="40px" width="40px" style="margin-left: 25px;"></a></p>
    <p>&copy; Opensource Project : SOCALM</p> <br />
  </footer>

  <script>
    let map = new Tmapv2.Map("map-container", {
      center: new Tmapv2.LatLng(36.6256, 127.4545),
      width: "100%",
      height: "700px",
      zoom: 16
    });

    const markers = [];
    const infoWindows = [];

    let pendingClick = null;

    async function loadDangerPoints() {
      try {
        const response = await fetch("/danger-data");
        const data = await response.json();

        Object.values(data).forEach(item => {
          const lat = item["위도"];
          const lng = item["경도"];
          const danger = item["위험도"];
          const location = item["지점명"];

          const dangerColors = {
            "아주 약함": "#4caf50", //초록
            "약함": "#ffeb3b", // 노랑
            "보통": "#ff9800", // 주황색
            "위험": "#f44336", // 빨강
            "매우 위험": "#9c27b0" // 보라색
          };

          const color = dangerColors[danger] || "#333"; // 검정색 

          new Tmapv2.Marker({
            position: new Tmapv2.LatLng(lat, lng),
            map: map,
            title: location
          });

          new Tmapv2.InfoWindow({
            position: new Tmapv2.LatLng(lat, lng),
            content: `<div style="color: ${color}; white-space: nowrap; font-size: 15px; font-weight: bold;">${danger}</div>`,
            type: 2,
            map: map
          });
        });
      } catch (error) {
        console.error("danger-data 불러오기 실패:", error);
      }
    }

    loadDangerPoints();

    map.addListener("click", function (evt) {

      const lat = evt.latLng._lat;
      const lon = evt.latLng._lng;

      pendingClick = { lat, lon };

      const reportDiv = document.getElementById("report");
      reportDiv.style.display = "block";
      reportDiv.scrollIntoView({ behavior: "smooth" });
      document.querySelector("input[name='location']").focus();
    });

    document.getElementById("report-form").addEventListener("submit", function (e) {
      e.preventDefault();

      if (!pendingClick) {
        alert("지도를 클릭해서 위치를 먼저 선택해주세요.");
        return;
      }

      const locationName = document.querySelector("input[name='location']").value.trim();
      const description = document.querySelector("textarea[name='description']").value.trim();

      if (!locationName || !description) {
        alert("모든 항목을 입력해주세요.");
        return;
      }

      const { lat, lon } = pendingClick;

      const marker = new Tmapv2.Marker({
        position: new Tmapv2.LatLng(lat, lon),
        map: map
      });
      markers.push(marker);

      const infoWindow = new Tmapv2.InfoWindow({
        position: new Tmapv2.LatLng(lat, lon),
        content: `<div style="background:white;padding:5px;border-radius:5px"><strong>${locationName}</strong><br>${description}</div>`,
        type: 2,
        map: map
      });
      infoWindows.push(infoWindow);

      map.setCenter(new Tmapv2.LatLng(lat, lon));

      document.getElementById("report-form").reset();
      document.getElementById("report").style.display = "none";
      pendingClick = null;
    });

    document.getElementById("cancel-report").addEventListener("click", function () {
      if (markers.length > 0) {
        const lastMarker = markers.pop();
        lastMarker.setMap(null);
      }

      if (infoWindows.length > 0) {
        const lastInfoWindow = infoWindows.pop();
        lastInfoWindow.setMap(null);
      }

      document.getElementById("report-form").reset();
      document.getElementById("report").style.display = "none";
      pendingClick = null;
      alert("가장 최근의 제보가 취소되었습니다.");
    });

    document.getElementById("close-report").addEventListener("click", function () {
      document.getElementById("report").style.display = "none";
      document.getElementById("report-form").reset();
      pendingClick = null;
    });
  </script>
  <script>
  document.getElementById('getLocationBtn').addEventListener('click', function() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition, showError);
  } else {
    alert("이 브라우저는 위치 정보를 지원하지 않습니다.");
  }
  });
  let myLocationMarker; // 내 위치 마커 변수 (중복 마커 방지)
  function showPosition(position) {
  const lat = position.coords.latitude;
  const lon = position.coords.longitude;

  // 기존 마커가 있다면 제거
  if (myLocationMarker) {
    myLocationMarker.setMap(null);
  }

  // 내 위치에 마커 찍기
  myLocationMarker = new Tmapv2.Marker({
    position: new Tmapv2.LatLng(lat, lon),
    map: map,
    icon: "/static/cur_loc.png",
    title: "내 위치"
  });

  // 지도 중심 이동
  map.setCenter(new Tmapv2.LatLng(lat, lon));

  alert(`현재 위치가 지도에 표시 되었습니다!`);
  }
  function showError(error) {
  alert("위치 정보를 가져오는 데 실패했습니다.");
  }
</script>
</body>
</html>
