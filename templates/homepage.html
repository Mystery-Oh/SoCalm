<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ë³´í–‰ì ì•ˆì „ë„ í‰ê°€ ì§€ë„</title>
  <link rel="stylesheet" href="{{ url_for('static', filename = 'style.css') }}">
  <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey={{ tmap_app_key }}"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
  <header>
    <div class="header-container">
      <div id="socalm">
        <a href="/"><img src="{{ url_for('static', filename='SOCALM.png') }}" height="100px" width="100px"></a>
      </div>
      <div class="navigation">
        <ul>
          <div id="logout">
            <form method="post" action="/logout">
              <button type="submit" id="no-button">
                <i class="fas fa-sign-out-alt"></i>
              </button>
            </form>
          </div>

        </ul>
      </div>

    </div>
  </header>

  <main>
    <section id="point-a-map">
      <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div id="map" style="flex: 2;">
          <h2>ì§€ë„ í´ë¦­ í›„ ì œë³´í•˜ê¸°</h2>

          <button id="getLocationBtn" style="margin-bottom: 10px;"> ë‚´ ìœ„ì¹˜ ë³´ê¸°</button>

          <div id="map-container" style="height: 700px;"></div>
        </div>

        <div id="report" style="flex: 1; display: none;">
          <div class="close-btn" id="close-report">âœ•</div>
          <h2>ìœ„í—˜ì§€ì—­ ì œë³´</h2>
          <form id="report-form" action="/report" method="post">
            <label>ìœ„ì¹˜ëª…: <input type="text" name="location" required></label><br>
            <label>ì„¤ëª…: <textarea name="description" required></textarea></label><br>
            <button type="submit">ì œë³´í•˜ê¸°</button>
            <button type="button" id="cancel-report">ì·¨ì†Œí•˜ê¸°</button>
          </form>
        </div>
      </div>
    </section>

    <div id="weather-to">
      <h2 style="font-size: 20px;">ì˜¤ëŠ˜ì˜ ë‚ ì”¨   <img id="weather-icon" src="/static/default.jpg" alt="ë‚ ì”¨ ì•„ì´ì½˜" style="width:30px; height:30px;" /></h2>
      <div class="weather-box">
        <div id="weather-icon-box">
        </div>
        <div id="weather-temp-box">
          <h2 id="weather-temp"></h2>
        </div>
        <div id="weather-nav">
          <ul>
            <li><p id="weather-humidity"></p></li>
            <li><p id="weather-wind"></p></li>
            <li><p id="weather-rain"></p></li>
          </ul>
        </div>
      </div>
    </div>
    
    

  <footer>
    <h2>SoCalm</h2>
    <p>This project is an open source project. Our team is composed of members from the Department of Computer Engineering and the Department of Software.</p>
    <p style="font-size: 13px;">developers: (Oh-heeseung, Leejungjoo, Jang hyun gyu)<a href="https://github.com/Mystery-Oh/SoCalm"><img src="{{ url_for('static', filename='Github.png') }}" height="40px" width="40px" style="margin-left: 25px;"></a></p>
    <p>&copy; Opensource Project : SOCALM</p> <br />
  </footer>

  <script>
  async function loadWeatherData() {
      try {
        const response = await fetch("/danger-data");
        const data = await response.json();

        const firstKey = Object.keys(data)[0];
        const weather = data[firstKey]["ë‚ ì”¨"]["2000"]; 

        const temperature = weather["T1H"]; // ê¸°ì˜¨
        const humidity = weather["REH"];   // ìŠµë„
        const wind = weather["WSD"];       // í’ì†
        const rainType = weather["PTY"];   // ê°•ìˆ˜ í˜•íƒœ
        const rainAmount = weather["RN1"]; // ê°•ìˆ˜ëŸ‰

        const rainTypeText = {
          "0": "ì—†ìŒ",
          "1": "ë¹„",
          "2": "ë¹„/ëˆˆ",
          "3": "ëˆˆ",
          "4": "ì†Œë‚˜ê¸°"
        }[rainType] || "ì •ë³´ ì—†ìŒ";

        let imageFile = "default.jpg";
        if (rainType === "0") {
          imageFile = "sunny.jpg";
        } else if (rainType === "1") {
          imageFile = "rainny.jpg";
        } else if (rainType === "2") {
          imageFile = "snowrain.jpg";
        } else if (rainType === "3") {
          imageFile = "snow.jpg";
        } else if (rainType === "4") {
          imageFile = "shower.jpg";
        }

        document.getElementById("weather-icon").src = `/static/${imageFile}`;
        document.getElementById("weather-temp").textContent = `ê¸°ì˜¨: ${temperature}â„ƒ`;
        document.getElementById("weather-humidity").textContent = `ğŸ’§ ìŠµë„: ${humidity}%`;
        document.getElementById("weather-wind").textContent = `ğŸŒ¬ï¸ í’ì†: ${wind} m/s`;
        document.getElementById("weather-rain").textContent = `â˜‚ï¸ ê°•ìˆ˜: ${rainTypeText} (${rainAmount}mm)`;

      } catch (err) {
        console.error("ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
        document.getElementById("weather-to").innerHTML += "<p>ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
      }
    }

    loadWeatherData();
    

    let map = new Tmapv2.Map("map-container", {
      center: new Tmapv2.LatLng(36.6256, 127.4545),
      width: "100%",
      height: "700px",
      zoom: 16
    });

    const markers = [];
    const infoWindows = [];

    let pendingClick = null;

    async function loadDangerPoints() {
      try {
        const response = await fetch("/danger-data");
        const data = await response.json();

        Object.values(data).forEach(item => {
          const lat = item["ìœ„ë„"];
          const lng = item["ê²½ë„"];
          const danger = item["ìœ„í—˜ë„"];
          const location = item["ì§€ì ëª…"];

          const dangerColors = {
            "ì•„ì£¼ ì•½í•¨": "#4caf50", //ì´ˆë¡
            "ì•½í•¨": "#ffeb3b", // ë…¸ë‘
            "ë³´í†µ": "#ff9800", // ì£¼í™©ìƒ‰
            "ìœ„í—˜": "#f44336", // ë¹¨ê°•
            "ë§¤ìš° ìœ„í—˜": "#9c27b0" // ë³´ë¼ìƒ‰
          };

          const color = dangerColors[danger] || "#333"; // ê²€ì •ìƒ‰ 

          new Tmapv2.Marker({
            position: new Tmapv2.LatLng(lat, lng),
            map: map,
            title: location
          });

          new Tmapv2.InfoWindow({
            position: new Tmapv2.LatLng(lat, lng),
            content: `<div style="color: ${color}; white-space: nowrap; font-size: 15px; font-weight: bold;">${danger}</div>`,
            type: 2,
            map: map
          });
        });
      } catch (error) {
        console.error("danger-data ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
      }
    }

    loadDangerPoints();

    map.addListener("click", function (evt) {

      const lat = evt.latLng._lat;
      const lon = evt.latLng._lng;

      pendingClick = { lat, lon };

      const reportDiv = document.getElementById("report");
      reportDiv.style.display = "block";
      reportDiv.scrollIntoView({ behavior: "smooth" });
      document.querySelector("input[name='location']").focus();
    });

    document.getElementById("report-form").addEventListener("submit", function (e) {
      e.preventDefault();

      if (!pendingClick) {
        alert("ì§€ë„ë¥¼ í´ë¦­í•´ì„œ ìœ„ì¹˜ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }

      const locationName = document.querySelector("input[name='location']").value.trim();
      const description = document.querySelector("textarea[name='description']").value.trim();

      if (!locationName || !description) {
        alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      const { lat, lon } = pendingClick;

      const marker = new Tmapv2.Marker({
        position: new Tmapv2.LatLng(lat, lon),
        map: map
      });
      markers.push(marker);

      const infoWindow = new Tmapv2.InfoWindow({
        position: new Tmapv2.LatLng(lat, lon),
        content: `<div style="background:white;padding:5px;border-radius:5px"><strong>${locationName}</strong><br>${description}</div>`,
        type: 2,
        map: map
      });
      infoWindows.push(infoWindow);

      map.setCenter(new Tmapv2.LatLng(lat, lon));

      document.getElementById("report-form").reset();
      document.getElementById("report").style.display = "none";
      pendingClick = null;
    });

    document.getElementById("cancel-report").addEventListener("click", function () {
      if (markers.length > 0) {
        const lastMarker = markers.pop();
        lastMarker.setMap(null);
      }

      if (infoWindows.length > 0) {
        const lastInfoWindow = infoWindows.pop();
        lastInfoWindow.setMap(null);
      }

      document.getElementById("report-form").reset();
      document.getElementById("report").style.display = "none";
      pendingClick = null;
      alert("ê°€ì¥ ìµœê·¼ì˜ ì œë³´ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    });

    document.getElementById("close-report").addEventListener("click", function () {
      document.getElementById("report").style.display = "none";
      document.getElementById("report-form").reset();
      pendingClick = null;
    });
  </script>
  <script>
  document.getElementById('getLocationBtn').addEventListener('click', function() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition, showError);
  } else {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
  }
  });
  let myLocationMarker; // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ ë³€ìˆ˜ (ì¤‘ë³µ ë§ˆì»¤ ë°©ì§€)
  function showPosition(position) {
  const lat = position.coords.latitude;
  const lon = position.coords.longitude;

  // ê¸°ì¡´ ë§ˆì»¤ê°€ ìˆë‹¤ë©´ ì œê±°
  if (myLocationMarker) {
    myLocationMarker.setMap(null);
  }

  // ë‚´ ìœ„ì¹˜ì— ë§ˆì»¤ ì°ê¸°
  myLocationMarker = new Tmapv2.Marker({
    position: new Tmapv2.LatLng(lat, lon),
    map: map,
    icon: "/static/cur_loc.png",
    title: "ë‚´ ìœ„ì¹˜"
  });

  // ì§€ë„ ì¤‘ì‹¬ ì´ë™
  map.setCenter(new Tmapv2.LatLng(lat, lon));

  alert(`í˜„ì¬ ìœ„ì¹˜ê°€ ì§€ë„ì— í‘œì‹œ ë˜ì—ˆìŠµë‹ˆë‹¤!`);
  }
  function showError(error) {
  alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
  }
</script>
</body>
</html>